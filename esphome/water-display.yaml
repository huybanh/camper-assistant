esphome:
  name: water-display
  friendly_name: Water Display

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: esp-idf

logger:
  level: DEBUG
  #hardware_uart: USB_SERIAL_JTAG

# Enable Home Assistant API
api:
  encryption:
    key: "8LxVKtDH9fEYmEpaisTuRXBHeqQ0nCfZFHeGDFDckHs="

ota:
  - platform: esphome
    password: "bbb2fe09bf5ac66677bc4cb1475f23bd"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Water-Display Fallback Hotspot"
    password: "a2wp77RW1Rp6"

captive_portal:
    
#external_components:
#  - source:
#      type: git
#      url: https://github.com/clydebarrow/esphome
#      ref: fd15094c0860df23d532881df36cfd16c7da1091 #previous commit - wont be needed in the future
#    components: [ lvgl ] 

globals:
  - id: time_counter
    type: int
    initial_value: '0'

number:
  - platform: template
    initial_value: 0
    id: counting_number
    internal: True
    min_value: -10
    max_value: 10
    step: 1
    optimistic: True


debug:
  update_interval: 5s

text_sensor:
  - platform: debug
    device:
      name: "Device Info"
    reset_reason:
      name: "Reset Reason"

sensor:
  - platform: debug
    free:
      name: "Heap Free"
    block:
      name: "Heap Max Block"
    loop_time:
      name: "Loop Time"
    #psram:
    #  name: "Free PSRAM"
  - platform: wifi_signal
    # name: "WiFi Signal Sensor"
    internal: True
    id: wifi_signal_sensor
    update_interval: 1s
  - platform: uptime
    id: uptime_counter
    update_interval: 1s
    accuracy_decimals: 0
    on_raw_value:
      then:
        - light.turn_on:
            id: back_light
            brightness: 50%
        - number.increment:
            id: counting_number
            cycle: True
        - script.execute: update_display

  - platform: homeassistant
    id: ha_water_temp
    entity_id: sensor.first_8266_camper_temperature
    #internal: True
    on_value:
      then:
          - lvgl.label.update:
              id: label_temp
              text: !lambda
                float sensor_value = id(ha_water_temp).state;
                char buffer[32];
                sprintf(buffer, "%.1f", sensor_value);
                return {std::string(buffer)};

    on_value_range:
      - above: 0.0
        then:
          #- lvgl.label.update:
          #    id: battery_charging_discharging
          #    text_color: 0x00FF00
          #    text: "charging"
      - below: 0.0
        then:

spi:
  clk_pin: GPIO6
  mosi_pin: GPIO7

output:
  - platform: ledc
    pin:
      number: GPIO3
    id: backlight_output

light:
  - platform: monochromatic
    output: backlight_output
    name: LCD Backlight
    id: back_light
    restore_mode: ALWAYS_ON
    #default_transition_length: 0s

display:
  - platform: ili9xxx
    id: lcd_display
    model: gc9a01a
    data_rate: 80MHz
    cs_pin: GPIO10
    dc_pin: GPIO2
    dimensions:
      width: 240
      height: 240
    update_interval: never
    auto_clear_enabled: false
    invert_colors: False

#time:
#  - platform: homeassistant
#    id: time_comp

script:
  - id: update_display
    then:
      #- lvgl.indicator.line.update:
      #    id: indicator_battery_power
      #    value: !lambda return id(counting_number).state * 10; #multiply by 10 because LVGL meter only supports integers
      #- lvgl.label.update:
      #    id: label_battery_soc
      #    text:
      #      format: "%.1f%%"
      #      args: [ 'id(counting_number).state' ]


      #- lvgl.img.update:
          #id: img_power
          #src: power_icon
          #img_recolor: 0xFFF000 #mixes this color with the base image
          #img_recolor_opa: 100% #opacity defaults to 0% = must set this for recolor to take effect
          #bg_color: 0xFFFFFF          

i2c:
  sda: 4
  scl: 5
  id: i2c_touch

touchscreen:
  platform: cst816
  id: my_touchscreen
  interrupt_pin: 0
  reset_pin: 1
  on_touch:
    then:
      lvgl.page.next:

font:
  - file: "fonts/GoogleSans-Medium.ttf"
    id: big_font
    size: 60
    bpp: 2
  - file: "fonts/GoogleSans-Medium.ttf"
    id: small_font
    size: 30
    bpp: 2

  - file: "fonts/GoogleSans-Medium.ttf"
    id: xs_font
    size: 20
    bpp: 2

lvgl:
    touchscreens: my_touchscreen
    log_level: INFO
    color_depth: 16
    bg_color: 0
    border_width: 0
    outline_width: 0
    #shadow_width: 0
    text_font: unscii_16
    align: center
    style_definitions:
      - id: font_style
        text_font: MONTSERRAT_28
        #text_font: unscii_16
        align: center
        text_color: 0x0
        #bg_opa: cover
        bg_opa: TRANSP
        bg_color: 0
        radius: 4
        pad_all: 2 
        
    page_wrap: true
    pages:
      - id: main_page
        widgets:
          - obj: # Meter
              height: 240 # needed to be explicitily defined for my round display to not have weird border line overlapping gauge
              width: 240
              align: center
              bg_color: 0xFFFFFF
              #bg_opa: TRANSP
              border_width: 0
              outline_width: 0
              #shadow_width: 0
              pad_all: 0
              scrollbar_mode: "off"
              clip_corner: true
              radius: 120
              widgets:
                - label:
                    styles: font_style
                    id: label_current_use
                    text_font: small_font
                    y: -40
                    x: -50
                    text: 3.2
                    text_align: RIGHT
                - label:
                    styles: font_style
                    text_font: xs_font
                    y: -50
                    x: -20
                    text: L
                - label:
                    styles: font_style
                    id: label_remain
                    text_font: small_font
                    y: -40
                    x: 45
                    text: 142
                - label:
                    styles: font_style
                    text_font: xs_font
                    y: -50
                    x: 75
                    text: L
                - label:
                    styles: font_style
                    id: label_temp
                    text_font: big_font
                    y: 20
                    text: "..."
                - label:
                    styles: font_style
                    text_font: xs_font
                    y: -5
                    x: 75
                    text: "Â°C"
                - bar:
                    x: 60
                    y: 185
                    id: bar_id
                    value: 20
                    min_value: 10
                    max_value: 40
                    width: 120
                    indicator:
                      bg_color: 0xF54927

      - id: advanced
        widgets:
          - label:
              styles: font_style
              text_font: MONTSERRAT_18 # override font size
              y: 0 #negative = higher
              x: 0
              text: "Settings Page"



